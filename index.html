<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本转图片 @Rebout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&amp;family=Noto+Serif+SC:wght@200;300;400;500;600;700;900&amp;display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'system': ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        'noto-sans': ['"Noto Sans SC"', 'sans-serif'],
                        'noto-serif': ['"Noto Serif SC"', 'serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            user-select: none;
        }

        .font-system {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .font-noto-sans {
            font-family: "Noto Sans SC", sans-serif;
        }

        .font-noto-serif {
            font-family: "Noto Serif SC", serif;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .color-item {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .color-item:hover {
            transform: scale(1.1);
        }

        .color-item.selected {
            border-color: #3b82f6;
        }

        .color-item.transparent {
            background: linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
                linear-gradient(-45deg, #f3f4f6 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f3f4f6 75%),
                linear-gradient(-45deg, transparent 75%, #f3f4f6 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
        }

        /* 预览显示样式 */
        .preview-image {
            zoom: 0.75;
            border-radius: 12px;
        }

        /* 自定义渲染容器样式 */
        .render-container {
            flex: 1;
            background: white;
            padding: 30px;
            padding-top: 30px;
            padding-bottom: 30px;
            box-sizing: border-box;
        }

        .ai-badge {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            color: #000 !important;
        }

        .ai-icon {
            margin-right: 6px;
            display: inline-block;
            width: 24px;
            height: 24px;
            color: #000 !important;
        }

        .dark-theme .ai-badge {
            color: #000 !important;
            background-color: #ffffff;
            border-radius: 12px;
            padding: 5px;
            margin-left: -5px;
            margin-right: -5px;
        }

        .dark-theme #aiLabelText {
            color: #000 !important;
        }

        .disclaimer {
            margin-top: 1rem;
            line-height: 1.4;
            color: #000 !important;
        }

        .dark-theme .disclaimer {
            color: #ffffff !important;
        }

        .main-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        /* Markdown 样式 */
        .main-content think {
            display: block;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .main-content think::before {
            content: "AI 思考";
            display: block;
            font-weight: normal;
            font-size: 0.8rem;
            padding-bottom: 1rem;
        }

        .main-content think {
            background: rgba(0, 0, 0, 0.05);
        }

        .dark-theme .main-content think {
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content think::before {
            color: #000 !important;
        }

        .dark-theme .main-content think::before {
            color: #fff !important;
        }

        .main-content h1 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content h2 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content h3 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content h4 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content h5 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content h6 {
            margin: 0;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .main-content p {
            margin: 0;
            margin-bottom: 1rem;
        }

        .main-content ul,
        .main-content ol {
            margin: 0;
            padding-left: 1.5em;
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .main-content ol {
            list-style-type: decimal;
            /* 显示数字 */
        }

        .main-content ul {
            list-style-type: disc;
            /* 显示圆点 */
        }

        .main-content blockquote {
            margin: 0;
            margin-bottom: 1rem;
            padding: 0.5em 1em;
            border-left: 4px solid currentColor;
            opacity: 0.8;
        }

        .main-content blockquote p:first-child:last-child {
            margin-bottom: 0;
        }


        .main-content code {
            font-family: monospace;
        }

        .main-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 1em;
            border-radius: 12px;
            overflow-x: auto;
            white-space: pre-line;
            margin-bottom: 1rem;
        }

        .dark-theme .main-content pre {
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content pre code {
            background: none;
            padding: 0;
        }

        .main-content hr {
            margin: 0;
            margin-bottom: 1rem;
            border: none;
            border-top: 1px solid currentColor;
        }

        .main-content strong {
            font-weight: bold;
        }

        .main-content em {
            font-style: italic;
        }


        .main-content table {
            width: 100%;
            margin: 0;
            margin-bottom: 1rem;
        }

        .main-content table thead {
            margin: 0;
            margin-bottom: 1rem;
        }

        .width-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .width-input {
            width: 80px;
        }

        /* KaTeX样式优化 */
        .katex {
            font-size: 1em !important;
        }

        .katex-display {
            margin: 1em 0 !important;
        }

        /* 文件上传样式 */
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .file-upload-area.dark:hover {
            background-color: #1f2937;
        }

        .file-upload-preview {
            max-width: 100%;
            max-height: 60px;
            border-radius: 4px;
        }
    </style>

    <style id="custom-css-style"></style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 h-screen overflow-hidden">
    <!-- 检测暗色模式 -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="flex h-full md:flex-row flex-col-reverse">
        <!-- 左侧控制面板 -->
        <div
            class="md:w-80 w-full bg-white dark:bg-gray-800 border-t border-gray-200 md:border-t-0 md:border-r md:border-gray-200 dark:border-gray-700 overflow-y-auto md:flex md:flex-col md:h-full [height:calc(70%)] md:[height:calc(100%)] user-select-none">

            <div class="p-4 pb-0 pt-0">
                <!-- 标题 -->
                <div class="sticky top-0 pt-4 z-10 pb-4 bg-white dark:bg-gray-800">
                    <h1 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                        <i class="fas fa-image mr-2 text-blue-600"></i>
                        文本转图片
                    </h1>
                </div>

                <!-- 文本输入 -->
                <div>

                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                        <i class="fas fa-edit mr-2"></i>
                        文本内容 <span class="text-xs text-gray-500 ml-2">(支持 Markdown)</span>
                    </label>
                    <textarea id="textInput"
                        placeholder="支持 Markdown 语法和 LaTeX 公式&#10;&#10;例如：&#10;这是行内公式：$E = mc^2$&#10;这是块级公式：&#10;$$&#10;\sum_{i=1}^{n} x_i = x_1 + x_2 + \cdots + x_n&#10;$$&#10;也支持LaTeX代码块：&#10;```latex&#10;E = mc^2&#10;```"
                        class="w-full px-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
                        resize-y" rows="12"></textarea>


                    <div class="flex justify-end gap-2">
                        <button id="copytextBtn" title="复制" onclick="
                                    var textInput = document.getElementById('textInput');
                                    textInput.select();
                                    document.execCommand('copy');
                                "
                            class="h-[32px] w-[32px] flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <i class="fas fa-copy"></i>
                        </button>

                        <button id="pastetextBtn" title="粘贴" onclick="
                                    navigator.clipboard.readText()
                                        .then(text => {
                                            const textInput = document.getElementById('textInput');
                                            const start = textInput.selectionStart;
                                            const end = textInput.selectionEnd;
                                            textInput.setRangeText(text, start, end, 'end');
                                            textInput.focus();
                                            textInput.dispatchEvent(new InputEvent('input', { bubbles: true }));
                                        })
                                        .catch(err => {
                                            showCustomModal('粘贴失败', '无法读取剪贴板内容，请确认浏览器权限已开启');
                                            console.error(err);
                                        });
                                "
                            class="h-[32px] w-[32px] flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <i class="fas fa-paste"></i>
                        </button>

                        <button id="clearTextBtn" title="清空" onclick="
                                    var textInput = document.getElementById('textInput');
                                    textInput.value = '';
                                    textInput.dispatchEvent(new InputEvent('input', { bubbles: true }));
                                "
                            class="h-[32px] w-[32px] flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                </div>


                <!-- AI 标识选择 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-robot mr-2"></i>AI 标识</label>
                    <select id="aiLabelSelect"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-blue-500">
                        <option value="chatgpt">ChatGPT</option>
                        <option value="gemini">Gemini</option>
                        <option value="claude">Claude</option>
                        <option value="qwen">Qwen</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="grok">Grok</option>
                        <option value="kimi">Kimi</option>
                        <option value="ai" selected>AI 生成</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="text" id="customAiLabel" placeholder="输入自定义 AI 标识..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-blue-500 hidden mt-4">
                </div>


                <!-- 免责声明文本 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        免责声明
                    </label>
                    <textarea id="disclaimerInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base resize-none focus:ring-2 focus:ring-blue-500
                        resize-y" rows="3">AI 模型可能会犯错误、误解意图、产生幻觉或给出不正确的答案。</textarea>
                </div>

                <!-- 字体设置 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-font mr-2"></i>字体</label>
                    <select id="fontSelect"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-blue-500">
                        <option value="system">系统默认字体</option>
                        <option value="noto-sans">Noto Sans SC (思源黑体)</option>
                        <option value="noto-serif">Noto Serif SC (思源宋体)</option>
                    </select>
                </div>

                <!-- 字体大小 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-text-height mr-2"></i>字体大小: <span id="fontSizeDisplay"
                            class="ml-2 text-blue-600 font-semibold">20px</span></label>
                    <input type="range" id="fontSizeSlider" min="16" max="32" value="20"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                </div>

                <!-- 图片宽度 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-arrows-alt-h mr-2"></i>图片宽度</label>
                    <div class="width-control">
                        <label class="flex items-center"><input type="radio" name="widthMode" value="auto" checked
                                class="mr-2"><span class="text-sm text-gray-700 dark:text-gray-300">自动</span></label>
                        <label class="flex items-center"><input type="radio" name="widthMode" value="custom"
                                class="mr-2"><span class="text-sm text-gray-700 dark:text-gray-300">自定义</span></label>
                        <input type="number" id="customWidth" value="400" min="200" max="800" step="50"
                            class="width-input px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                            disabled>
                        <span class="text-xs text-gray-500">px</span>
                    </div>
                </div>

                <!-- 对齐方式 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-align-left mr-2"></i>文字对齐</label>
                    <div class="flex space-x-2">
                        <button
                            class="align-btn flex-1 py-2 px-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 bg-blue-50 dark:bg-blue-900 border-blue-500"
                            data-align="left"><i class="fas fa-align-left dark:text-white"></i></button>
                        <button
                            class="align-btn flex-1 py-2 px-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 border-gray-300 dark:border-gray-600"
                            data-align="center"><i class="fas fa-align-center dark:text-white"></i></button>
                        <button
                            class="align-btn flex-1 py-2 px-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 border-gray-300 dark:border-gray-600"
                            data-align="right"><i class="fas fa-align-right dark:text-white"></i></button>
                    </div>
                </div>
                <!-- 图片主题 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-adjust mr-2"></i>图片主题</label>
                    <div class="flex space-x-2">
                        <button
                            class="theme-btn flex-1 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 bg-blue-50 dark:bg-blue-900 border-blue-500 dark:border-blue-900 dark:text-white"
                            data-theme="light"><i class="fas fa-sun mr-2"></i>浅色</button>
                        <button
                            class="theme-btn flex-1 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500 dark:text-white"
                            data-theme="dark"><i class="fas fa-moon mr-2 "></i>深色</button>
                    </div>
                </div>
                <!-- 文字颜色 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-palette mr-2"></i>文字颜色</label>
                    <div class="color-palette" id="textColorPalette"></div>
                </div>
                <!-- 背景颜色 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-fill-drip mr-2"></i>背景颜色</label>
                    <div class="color-palette" id="bgColorPalette"></div>
                </div>

                <!-- 自定义样式 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-paint-brush mr-2"></i>自定义颜色与背景</label>

                    <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">字体颜色</span>
                            <input type="color" id="font-color-picker" value="#000000"
                                class="w-10 h-8 p-1 border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">背景颜色</span>
                            <input type="color" id="bg-color-picker" value="#ffffff"
                                class="w-10 h-8 p-1 border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                        </div>

                        <div>
                            <label for="bg-image-url" class="text-sm text-gray-600 dark:text-gray-400">背景图片
                                URL</label>
                            <input type="text" id="bg-image-url" placeholder="输入图片链接..."
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none focus:ring-2 focus:ring-blue-500 mt-2" />
                        </div>

                        <div>
                            <label for="bg-image-upload"
                                class="text-sm text-gray-600 dark:text-gray-400">或上传背景图片</label>
                            <div id="bg-image-upload-area" class="file-upload-area mt-2 dark:border-gray-600">
                                <input type="file" id="bg-image-upload" accept="image/*" class="hidden">
                                <div id="upload-prompt">
                                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">点击或拖拽上传图片</p>
                                </div>
                                <div id="upload-preview" class="hidden flex justify-center items-center flex-col">
                                    <img id="preview-img" class="file-upload-preview">
                                    <p class="text-sm text-gray-600 mt-2">已上传背景图片</p>
                                    <button type="button" id="remove-bg-image"
                                        class="text-red-500 hover:text-red-700 text-sm mt-1">
                                        <i class="fas fa-trash mr-1"></i>移除
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="bg-image-opacity" class="text-sm text-gray-600 dark:text-gray-400">背景图片透明度:
                                <span id="bg-image-opacity-display">5%</span></label>
                            <input type="range" id="bg-image-opacity" min="0" max="1" step="0.05" value="0.05"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 mt-2">
                        </div>
                    </div>
                </div>

                <!-- 元素可见性 -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-eye mr-2"></i>元素可见性与元数据</label>
                    <div class="space-y-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <label class="flex items-center justify-between"><span
                                class="text-sm text-gray-600 dark:text-gray-400">显示 AI 标识</span><input type="checkbox"
                                id="show-ai-badge"
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                checked></label>
                        <label class="flex items-center justify-between"><span
                                class="text-sm text-gray-600 dark:text-gray-400">显示免责声明</span><input type="checkbox"
                                id="show-disclaimer"
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                checked></label>
                    </div>
                </div>

                <!-- 自定义 CSS -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 mt-4"><i
                            class="fas fa-code mr-2"></i>自定义 CSS</label>
                    <div id="custom-css-container"
                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden resize-y"
                        style="height: 500px;">
                        <textarea id="custom-css" class="hidden"></textarea>
                    </div>
                </div>

                <!-- 生成按钮 -->
                <div class="sticky bottom-0 pb-4 pt-4 bg-white dark:bg-gray-800">
                    <div class="flex gap-3">
                        <button id="copyBtn"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed w-1/2"
                            disabled="">
                            <i class="fas fa-copy mr-2"></i>
                            复制图片
                        </button>
                        <button id="downloadBtn"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed w-1/2"
                            disabled="">
                            <i class="fas fa-download mr-2"></i>
                            下载图片
                        </button>
                    </div>

                    <div class="flex text-center mt-4">
                        <p class="text-sm text-gray-500">由 @Rebout 制作 at <a class="text-blue-600 hover:underline"
                                href="https://linux.do/u/rebout/">Linux.do</a></p>
                    </div>
                </div>


            </div>
        </div>

        <!-- 右侧预览区域 -->
        <div class="flex-1 flex flex-col [height:calc(30%)] md:[height:calc(100%)] user-select-none">
            <!-- 预览内容 -->
            <div class="preview-container h-full w-full flex overflow-auto">
                <div class="flex w-full h-full p-4">
                    <div id="previewContainer" class="hidden flex" style="margin: auto;">
                        <img id="previewImage" class="shadow-lg preview-image" draggable="false">
                    </div>

                    <div id="placeholder" class="text-gray-400 dark:text-gray-500 text-center" style="margin: auto;">
                        <i class="fas fa-image text-6xl mb-4"></i>
                        <p class="text-xl mb-2">准备生成图片</p>
                        <p>输入文本以开始</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏的渲染容器 -->
    <div id="renderContainer" style="position: absolute; left: -9999px; top: -9999px; display: flex;">
        <div id="renderContent" class="render-container">
            <div id="background-image-layer"
                style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; z-index: -10">
            </div>

            <!-- AI标识 -->
            <div class="ai-badge" id="aiBadge">
                <img class="ai-icon" id="aiIcon" src="" alt="">
                <span id="aiLabelText">AI 生成</span>
                <span id="author-display" class="ml-2" style="display: none;"></span>
            </div>

            <!-- 主要文本内容 -->
            <div class="main-content" id="mainText"></div>

            <!-- 免责声明 -->
            <div class="disclaimer" id="disclaimerText">
                AI 模型可能会犯错误、误解意图、产生幻觉或给出不正确的答案。
            </div>

        </div>
    </div>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDN7NTRMPQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-ZDN7NTRMPQ');
    </script>

    <script src="./icons.js"></script>
    <script>
        // AI 标识文本
        const aiLabels = {
            chatgpt: 'ChatGPT',
            gemini: 'Gemini',
            claude: 'Claude',
            qwen: 'Qwen',
            deepseek: 'DeepSeek',
            grok: 'Grok',
            kimi: 'Kimi',
            ai: 'AI 生成',
            custom: ''
        };

        // 颜色配置 - 对应位置的颜色主题匹配
        const colorPalettes = {
            light: {
                text: ['#000000', '#1F2937', '#374151', '#6B7280', '#EF4444', '#F97316', '#EAB308', '#22C55E', '#3B82F6', '#8B5CF6', '#EC4899', '#06B6D4'],
                bg: ['transparent', '#FFFFFF', '#F9FAFB', '#F3F4F6', '#FEF2F2', '#FFF7ED', '#FEFCE8', '#F0FDF4', '#EFF6FF', '#F3E8FF', '#FDF2F8', '#ECFEFF']
            },
            dark: {
                text: ['#FFFFFF', '#F9FAFB', '#E5E7EB', '#9CA3AF', '#F78C8C', '#FDB37F', '#FBE066', '#7BFCAB', '#A6CEFE', '#D1A3FD', '#F897CC', '#71F3F5'],
                bg: ['transparent', '#000000', '#111827', '#1F2937', '#991B1B', '#C2410C', '#CA8A04', '#166534', '#1D4ED8', '#6D28D9', '#BE185D', '#0E7490']
            }
        };

        // 应用状态
        let currentImageData = null;
        let currentTextAlign = 'left'; // 默认左对齐
        let currentImageTheme = 'light';
        let currentTextColorIndex = 0;
        let currentBgColorIndex = 1;
        let uploadedBackgroundImage = null; // 存储上传的背景图片

        // 存储配置
        const STORAGE_KEY = 'text-to-image-settings';

        // 默认设置
        const defaultSettings = {
            textInput: '',
            aiLabelSelect: 'ai',
            customAiLabel: '',
            disclaimerInput: 'AI 模型可能会犯错误、误解意图、产生幻觉或给出不正确的答案。',
            fontSelect: 'system',
            fontSize: 20,
            widthMode: 'auto',
            customWidth: 400,
            textAlign: 'left',
            imageTheme: 'light',
            textColorIndex: 0,
            bgColorIndex: 1,
            fontColor: '#000000',
            bgColor: '#ffffff',
            bgImageUrl: '',
            bgImageOpacity: 0.05,
            showAiBadge: true,
            showDisclaimer: true,
            customCss: ''
        };

        // DOM 元素
        const elements = {
            textInput: document.getElementById('textInput'),
            aiLabelSelect: document.getElementById('aiLabelSelect'),
            customAiLabel: document.getElementById('customAiLabel'),
            disclaimerInput: document.getElementById('disclaimerInput'),
            fontSelect: document.getElementById('fontSelect'),
            fontSizeSlider: document.getElementById('fontSizeSlider'),
            fontSizeDisplay: document.getElementById('fontSizeDisplay'),
            customWidth: document.getElementById('customWidth'),
            generateBtn: document.getElementById('generateBtn'),
            copyBtn: document.getElementById('copyBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            previewContainer: document.getElementById('previewContainer'),
            placeholder: document.getElementById('placeholder'),
            previewImage: document.getElementById('previewImage'),
            renderContainer: document.getElementById('renderContainer'),
            renderContent: document.getElementById('renderContent'),
            mainText: document.getElementById('mainText'),
            aiLabelText: document.getElementById('aiLabelText'),
            aiIcon: document.getElementById('aiIcon'),
            aiBadge: document.getElementById('aiBadge'),
            disclaimerText: document.getElementById('disclaimerText'),
            textColorPalette: document.getElementById('textColorPalette'),
            bgColorPalette: document.getElementById('bgColorPalette'),
            fontColorPicker: document.getElementById('font-color-picker'),
            bgColorPicker: document.getElementById('bg-color-picker'),
            bgImageUrl: document.getElementById('bg-image-url'),
            bgImageOpacity: document.getElementById('bg-image-opacity'),
            bgImageOpacityDisplay: document.getElementById('bg-image-opacity-display'),
            backgroundImageLayer: document.getElementById('background-image-layer'),
            showAiBadge: document.getElementById('show-ai-badge'),
            showDisclaimer: document.getElementById('show-disclaimer'),
            customCss: document.getElementById('custom-css'),
            customCssStyle: document.getElementById('custom-css-style'),
            bgImageUpload: document.getElementById('bg-image-upload'),
            bgImageUploadArea: document.getElementById('bg-image-upload-area'),
            uploadPrompt: document.getElementById('upload-prompt'),
            uploadPreview: document.getElementById('upload-preview'),
            previewImg: document.getElementById('preview-img'),
            removeBgImage: document.getElementById('remove-bg-image')
        };

        // 存储相关函数
        function saveSettings() {
            const settings = {
                textInput: elements.textInput.value,
                aiLabelSelect: elements.aiLabelSelect.value,
                customAiLabel: elements.customAiLabel.value,
                disclaimerInput: elements.disclaimerInput.value,
                fontSelect: elements.fontSelect.value,
                fontSize: parseInt(elements.fontSizeSlider.value),
                widthMode: document.querySelector('input[name="widthMode"]:checked').value,
                customWidth: parseInt(elements.customWidth.value),
                textAlign: currentTextAlign,
                imageTheme: currentImageTheme,
                textColorIndex: currentTextColorIndex,
                bgColorIndex: currentBgColorIndex,
                fontColor: elements.fontColorPicker.value,
                bgColor: elements.bgColorPicker.value,
                bgImageUrl: elements.bgImageUrl.value,
                bgImageOpacity: parseFloat(elements.bgImageOpacity.value),
                showAiBadge: elements.showAiBadge.checked,
                showDisclaimer: elements.showDisclaimer.checked,
                customCss: elements.customCss.value
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                const settings = saved ? JSON.parse(saved) : defaultSettings;

                // 恢复基本设置
                elements.textInput.value = settings.textInput || defaultSettings.textInput;
                elements.aiLabelSelect.value = settings.aiLabelSelect || defaultSettings.aiLabelSelect;
                elements.customAiLabel.value = settings.customAiLabel || defaultSettings.customAiLabel;
                elements.disclaimerInput.value = settings.disclaimerInput || defaultSettings.disclaimerInput;
                elements.fontSelect.value = settings.fontSelect || defaultSettings.fontSelect;
                elements.fontSizeSlider.value = settings.fontSize || defaultSettings.fontSize;
                elements.fontSizeDisplay.textContent = (settings.fontSize || defaultSettings.fontSize) + 'px';
                elements.customWidth.value = settings.customWidth || defaultSettings.customWidth;
                elements.fontColorPicker.value = settings.fontColor || defaultSettings.fontColor;
                elements.bgColorPicker.value = settings.bgColor || defaultSettings.bgColor;
                elements.bgImageUrl.value = settings.bgImageUrl || defaultSettings.bgImageUrl;
                elements.bgImageOpacity.value = settings.bgImageOpacity || defaultSettings.bgImageOpacity;
                elements.bgImageOpacityDisplay.textContent = `${Math.round((settings.bgImageOpacity || defaultSettings.bgImageOpacity) * 100)}%`;
                elements.showAiBadge.checked = settings.showAiBadge !== undefined ? settings.showAiBadge : defaultSettings.showAiBadge;
                elements.showDisclaimer.checked = settings.showDisclaimer !== undefined ? settings.showDisclaimer : defaultSettings.showDisclaimer;
                elements.customCss.value = settings.customCss || defaultSettings.customCss;

                // 恢复状态变量
                currentTextAlign = settings.textAlign || defaultSettings.textAlign;
                currentImageTheme = settings.imageTheme || defaultSettings.imageTheme;
                currentTextColorIndex = settings.textColorIndex !== undefined ? settings.textColorIndex : defaultSettings.textColorIndex;
                currentBgColorIndex = settings.bgColorIndex !== undefined ? settings.bgColorIndex : defaultSettings.bgColorIndex;

                // 恢复宽度模式
                document.querySelector(`input[name="widthMode"][value="${settings.widthMode || defaultSettings.widthMode}"]`).checked = true;
                elements.customWidth.disabled = (settings.widthMode || defaultSettings.widthMode) === 'auto';

                // 恢复对齐按钮状态
                document.querySelectorAll('.align-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                    btn.classList.add('border-gray-300', 'dark:border-gray-600');
                });
                document.querySelector(`[data-align="${currentTextAlign}"]`).classList.add('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                document.querySelector(`[data-align="${currentTextAlign}"]`).classList.remove('border-gray-300', 'dark:border-gray-600');

                // 恢复主题按钮状态
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                    btn.classList.add('border-gray-300', 'dark:border-gray-600');
                });
                document.querySelector(`[data-theme="${currentImageTheme}"]`).classList.add('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                document.querySelector(`[data-theme="${currentImageTheme}"]`).classList.remove('border-gray-300', 'dark:border-gray-600');

                // 恢复自定义AI标识的显示状态
                if (elements.aiLabelSelect.value === 'custom') {
                    elements.customAiLabel.classList.remove('hidden');
                } else {
                    elements.customAiLabel.classList.add('hidden');
                }

            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }

        // --- Event Listeners ---

        // Event listeners for color pickers
        elements.fontColorPicker.addEventListener('input', () => {
            elements.textColorPalette.querySelectorAll('.color-item').forEach(item => item.classList.remove('selected'));
            currentTextColorIndex = -1; // Deselect palette
            generateImage();
            saveSettings();
        });
        elements.bgColorPicker.addEventListener('input', () => {
            elements.bgColorPalette.querySelectorAll('.color-item').forEach(item => item.classList.remove('selected'));
            currentBgColorIndex = -1; // Deselect palette
            generateImage();
            saveSettings();
        });

        elements.bgImageUrl.addEventListener('input', () => {
            // 清除上传的图片
            uploadedBackgroundImage = null;
            elements.uploadPrompt.classList.remove('hidden');
            elements.uploadPreview.classList.add('hidden');
            generateImage();
            saveSettings();
        });
        elements.bgImageOpacity.addEventListener('input', () => {
            elements.bgImageOpacityDisplay.textContent = `${Math.round(elements.bgImageOpacity.value * 100)}%`;
            generateImage();
            saveSettings();
        });

        elements.showAiBadge.addEventListener('change', () => {
            generateImage();
            saveSettings();
        });
        elements.showDisclaimer.addEventListener('change', () => {
            generateImage();
            saveSettings();
        });

        elements.customCss.addEventListener('input', () => {
            elements.customCssStyle.textContent = elements.customCss.value;
            generateImage();
            saveSettings();
        });

        // Add tab support to custom CSS textarea
        elements.customCss.addEventListener('keydown', function (e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        });

        // 背景图片上传相关事件
        elements.bgImageUploadArea.addEventListener('click', () => {
            elements.bgImageUpload.click();
        });

        elements.bgImageUpload.addEventListener('change', handleImageUpload);

        elements.removeBgImage.addEventListener('click', () => {
            uploadedBackgroundImage = null;
            elements.bgImageUrl.value = '';
            elements.uploadPrompt.classList.remove('hidden');
            elements.uploadPreview.classList.add('hidden');
            generateImage();
            saveSettings();
        });

        // 拖拽上传
        elements.bgImageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.bgImageUploadArea.style.borderColor = '#3b82f6';
        });

        elements.bgImageUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            elements.bgImageUploadArea.style.borderColor = '#d1d5db';
        });

        elements.bgImageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.bgImageUploadArea.style.borderColor = '#d1d5db';
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageFile(files[0]);
            }
        });

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedBackgroundImage = e.target.result;
                elements.previewImg.src = e.target.result;
                elements.uploadPrompt.classList.add('hidden');
                elements.uploadPreview.classList.remove('hidden');
                // 清空URL输入
                elements.bgImageUrl.value = '';
                generateImage();
                saveSettings();
            };
            reader.readAsDataURL(file);
        }

        // 获取当前主题的颜色
        function getCurrentColors() {
            return colorPalettes[currentImageTheme];
        }

        // 创建颜色选择器
        function createColorPalette(container, colors, selectedIndex, colorPicker, callback) {
            container.innerHTML = '';
            colors.forEach((color, index) => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item' + (index === selectedIndex ? ' selected' : '');

                if (color === 'transparent') {
                    colorItem.classList.add('transparent');
                } else {
                    colorItem.style.backgroundColor = color;
                }

                colorItem.addEventListener('click', () => {
                    container.querySelectorAll('.color-item').forEach(item =>
                        item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    if (color !== 'transparent') {
                        colorPicker.value = color;
                    }
                    callback(index);
                    saveSettings();
                });
                container.appendChild(colorItem);
            });
        }

        // 更新色板
        function updateColorPalettes() {
            const colors = getCurrentColors();

            createColorPalette(elements.textColorPalette, colors.text, currentTextColorIndex, elements.fontColorPicker, (index) => {
                currentTextColorIndex = index;
                generateImage();
            });

            createColorPalette(elements.bgColorPalette, colors.bg, currentBgColorIndex, elements.bgColorPicker, (index) => {
                currentBgColorIndex = index;
                generateImage();
            });
        }

        // AI标识选择变化处理
        elements.aiLabelSelect.addEventListener('change', () => {
            const selectedValue = elements.aiLabelSelect.value;
            if (selectedValue === 'custom') {
                elements.customAiLabel.classList.remove('hidden');
                elements.customAiLabel.focus();
            } else {
                elements.customAiLabel.classList.add('hidden');
            }
            generateImage();
            saveSettings();
        });

        elements.customAiLabel.addEventListener('input', () => {
            generateImage();
            saveSettings();
        });

        // 获取当前AI标识文本
        function getCurrentAiLabel() {
            const selectedValue = elements.aiLabelSelect.value;
            if (selectedValue === 'custom') {
                return elements.customAiLabel.value || '自定义';
            }
            return aiLabels[selectedValue];
        }

        // 获取当前AI图标
        function getCurrentAiIcon() {
            const selectedValue = elements.aiLabelSelect.value;
            if (selectedValue === 'custom') {
                return aiIcons.ai; // 使用默认AI图标
            }
            return aiIcons[selectedValue];
        }

        // 配置marked
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // 渲染markdown并应用相对字体大小（支持LaTeX）
        function renderMarkdownContent(text, baseFontSize, fontFamily, textAlign, textColor) {
            // 预处理：将 ```latex 代码块转换为数学公式
            text = text.replace(/```latex\s*\n([\s\S]*?)\n```/gi, (match, latexCode) => {
                const cleanedCode = latexCode.trim();
                return `$$${cleanedCode}$$`;
            });

            // 在 Markdown 渲染前先处理 LaTeX 公式
            // 处理块级公式 $$...$$（包括跨行的）
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                try {
                    return katex.renderToString(formula.trim(), {
                        displayMode: true,
                        throwOnError: false
                    });
                } catch (error) {
                    console.error('块级公式渲染错误:', error);
                    return match;
                }
            });

            // 处理行内公式 $...$
            text = text.replace(/\$([^$\n]+?)\$/g, (match, formula) => {
                try {
                    return katex.renderToString(formula.trim(), {
                        displayMode: false,
                        throwOnError: false
                    });
                } catch (error) {
                    console.error('行内公式渲染错误:', error);
                    return match;
                }
            });

            // 现在渲染 Markdown（LaTeX 已经变成 HTML 了）
            const html = marked.parse(text);
            elements.mainText.innerHTML = html;

            // 设置基础样式
            elements.mainText.style.fontSize = baseFontSize + 'px';
            elements.mainText.style.color = textColor;
            elements.mainText.style.textAlign = textAlign;
            elements.mainText.className = 'main-content font-' + fontFamily;

            // 设置标题的相对字体大小
            const headings = elements.mainText.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                const level = parseInt(heading.tagName.substring(1));
                const multiplier = Math.max(1.1, 1.3 - level * 0.1);
                heading.style.fontSize = (baseFontSize * multiplier) + 'px';
                heading.style.color = textColor;
            });

            // 确保所有文本元素都使用正确的颜色（排除 KaTeX 元素）
            const allElements = elements.mainText.querySelectorAll('*:not(.katex):not(.katex *)');
            allElements.forEach(el => {
                if (!el.style.color && !el.classList.contains('katex')) {
                    el.style.color = textColor;
                }
            });

            elements.aiBadge.className += ' font-' + fontFamily;
            elements.disclaimerText.className += ' font-' + fontFamily;
        }

        // 渲染Markdown和LaTeX文本
        function renderMarkdownText(text) {
            if (!text) return '';

            // 预处理LaTeX代码块
            text = text.replace(/```latex\s*\n([\s\S]*?)\n```/gi, (match, latexCode) => {
                const cleanedCode = latexCode.trim();
                return `$$${cleanedCode}$$`;
            });

            // 在 Markdown 渲染前先处理 LaTeX 公式
            // 处理块级公式 $$...$$
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                try {
                    return katex.renderToString(formula.trim(), {
                        displayMode: true,
                        throwOnError: false
                    });
                } catch (error) {
                    console.error('块级公式渲染错误:', error);
                    return match;
                }
            });

            // 处理行内公式 $...$
            text = text.replace(/\$([^$\n]+?)\$/g, (match, formula) => {
                try {
                    return katex.renderToString(formula.trim(), {
                        displayMode: false,
                        throwOnError: false
                    });
                } catch (error) {
                    console.error('行内公式渲染错误:', error);
                    return match;
                }
            });

            const html = marked.parse(text);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            return tempDiv.innerHTML;
        }

        // 宽度模式切换
        document.querySelectorAll('input[name="widthMode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                elements.customWidth.disabled = radio.value === 'auto';
                generateImage();
                saveSettings();
            });
        });

        elements.customWidth.addEventListener('input', () => {
            generateImage();
            saveSettings();
        });

        // 对齐按钮
        document.querySelectorAll('.align-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.align-btn').forEach(b => {
                    b.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                    b.classList.add('border-gray-300', 'dark:border-gray-600');
                });
                btn.classList.add('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                btn.classList.remove('border-gray-300', 'dark:border-gray-600');
                currentTextAlign = btn.dataset.align;
                generateImage();
                saveSettings();
            });
        });

        // 主题按钮
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.theme-btn').forEach(b => {
                    b.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                    b.classList.add('border-gray-300', 'dark:border-gray-600');
                });
                btn.classList.add('bg-blue-50', 'dark:bg-blue-900', 'border-blue-500');
                btn.classList.remove('border-gray-300', 'dark:border-gray-600');
                currentImageTheme = btn.dataset.theme;

                // 切换主题时保持颜色索引不变，但更新色板和预览
                updateColorPalettes();
                generateImage();
                saveSettings();
            });
        });

        // 字体大小滑块
        elements.fontSizeSlider.addEventListener('input', () => {
            elements.fontSizeDisplay.textContent = elements.fontSizeSlider.value + 'px';
            generateImage();
            saveSettings();
        });

        // 自定义模态框
        function showCustomModal(title, message, type = 'info') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

            const iconClass = type === 'success' ? 'fa-check-circle text-green-500' :
                type === 'error' ? 'fa-exclamation-circle text-red-500' :
                    'fa-info-circle text-blue-500';

            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="flex items-center mb-4">
                        <i class="fas ${iconClass} text-xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${title}</h3>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded transition-colors" onclick="this.closest('.fixed').remove()">确定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 生成图片
        async function generateImage() {
            const text = elements.textInput.value.trim();
            if (!text) {
                elements.placeholder.classList.remove('hidden');
                elements.previewContainer.classList.add('hidden');
                elements.copyBtn.disabled = true;
                elements.downloadBtn.disabled = true;
                return;
            }

            try {
                const fontSize = parseInt(elements.fontSizeSlider.value);
                const fontFamily = elements.fontSelect.value;
                const widthMode = document.querySelector('input[name="widthMode"]:checked').value;
                const customWidth = elements.customWidth.value;

                // 优先使用 color picker 的值, 这是所有颜色设置的最终来源
                const textColor = elements.fontColorPicker.value;
                const bgColor = elements.bgColorPicker.value;

                // --- 更新渲染内容 ---

                // 1. 可见性 和 元数据
                elements.aiBadge.style.display = elements.showAiBadge.checked ? 'flex' : 'none';
                elements.disclaimerText.style.display = elements.showDisclaimer.checked ? 'block' : 'none';

                // 2. 更新文本内容（支持Markdown和LaTeX）
                const aiLabelHtml = renderMarkdownText(getCurrentAiLabel());
                elements.aiLabelText.innerHTML = aiLabelHtml;
                elements.aiIcon.src = getCurrentAiIcon();

                const disclaimerHtml = renderMarkdownText(elements.disclaimerInput.value || '');
                elements.disclaimerText.innerHTML = disclaimerHtml;

                // 3. 渲染Markdown和LaTeX
                renderMarkdownContent(text, fontSize, fontFamily, currentTextAlign, textColor);

                // 4. 设置字体相对大小
                const aiBadgeSize = Math.max(10, fontSize * 0.8);
                const disclaimerSize = Math.max(8, fontSize * 0.8);
                elements.aiBadge.style.fontSize = aiBadgeSize + 'px';
                elements.aiBadge.style.opacity = '0.7';
                elements.disclaimerText.style.fontSize = disclaimerSize + 'px';
                elements.disclaimerText.style.opacity = '0.6';

                // 5. 设置主题和颜色
                if (currentImageTheme === 'dark') {
                    elements.renderContent.classList.add('dark-theme');
                } else {
                    elements.renderContent.classList.remove('dark-theme');
                }
                elements.renderContent.style.backgroundColor = bgColor;
                elements.aiBadge.style.color = textColor;
                elements.disclaimerText.style.color = textColor;

                // 6. 设置背景图片 - 优先使用上传的图片
                elements.renderContent.style.position = 'relative';
                const backgroundImageUrl = uploadedBackgroundImage || elements.bgImageUrl.value;
                if (backgroundImageUrl) {
                    elements.backgroundImageLayer.style.backgroundImage = `url('${backgroundImageUrl}')`;
                    elements.backgroundImageLayer.style.opacity = elements.bgImageOpacity.value;
                } else {
                    elements.backgroundImageLayer.style.backgroundImage = '';
                }

                // 7. 设置宽度
                if (widthMode === 'custom') {
                    elements.renderContainer.style.width = customWidth + 'px';
                    elements.renderContainer.style.maxWidth = customWidth + 'px';
                } else {
                    elements.renderContainer.style.width = 'auto';
                    elements.renderContainer.style.maxWidth = '600px';
                }

                // 等待字体和LaTeX渲染完成
                await document.fonts.ready;
                await new Promise(resolve => setTimeout(resolve, 100)); // 增加等待时间确保LaTeX完全渲染

                // 使用domtoimage生成图片，缩放1.25倍
                const dataUrl = await domtoimage.toPng(elements.renderContent, {
                    quality: 1,
                    bgcolor: bgColor === 'transparent' ? null : bgColor,
                    style: {
                        transform: 'scale(1.25)',
                        transformOrigin: 'top left'
                    },
                    width: elements.renderContent.offsetWidth * 1.25,
                    height: elements.renderContent.offsetHeight * 1.25
                });

                // 显示预览（0.75倍缩放）
                elements.previewImage.src = dataUrl;
                currentImageData = dataUrl;

                elements.placeholder.classList.add('hidden');
                elements.previewContainer.classList.remove('hidden');
                elements.copyBtn.disabled = false;
                elements.downloadBtn.disabled = false;

            } catch (error) {
                console.error('图片生成失败:', error);
                showCustomModal('错误', '图片生成失败，请重试', 'error');
            }
        }

        // 复制图片到剪贴板
        elements.copyBtn.addEventListener('click', async () => {
            if (!currentImageData) return;

            try {
                const response = await fetch(currentImageData);
                const blob = await response.blob();
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                showCustomModal('成功', '图片已复制到剪贴板', 'success');
            } catch (error) {
                console.error('复制失败:', error);
                showCustomModal('错误', '复制失败，请重试', 'error');
            }
        });

        // 下载图片
        elements.downloadBtn.addEventListener('click', () => {
            if (!currentImageData) return;

            const link = document.createElement('a');
            link.download = new Date().getTime() + ".png";
            link.href = currentImageData;
            link.click();
        });

        // 监听输入变化自动生成
        [elements.textInput, elements.disclaimerInput, elements.fontSelect].forEach(element => {
            element.addEventListener('input', () => {
                generateImage();
                saveSettings();
            });
            element.addEventListener('change', () => {
                generateImage();
                saveSettings();
            });
        });

        // 初始化
        function init() {
            // 加载设置
            loadSettings();
            // 更新色板
            updateColorPalettes();
            // 生成初始图片
            generateImage();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            let monacoEditor;

            // 先等待KaTeX加载完成
            function waitForKaTeX() {
                return new Promise((resolve) => {
                    if (typeof katex !== 'undefined') {
                        resolve();
                    } else {
                        const checkKaTeX = setInterval(() => {
                            if (typeof katex !== 'undefined') {
                                clearInterval(checkKaTeX);
                                resolve();
                            }
                        }, 50);
                    }
                });
            }

            // 等待KaTeX加载完成后再初始化Monaco Editor
            waitForKaTeX().then(() => {
                // --- Initialize Monaco Editor ---
                require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' } });
                require(['vs/editor/editor.main'], function () {
                    const container = document.getElementById('custom-css-container');

                    // 详细的CSS教学内容
                    const defaultCssContent = `/* CSS 自定义样式教程 - 以下是一些常用的样式示例 */
/* 主要元素
    容器 .render-container
    内容 .main-content
    ai标签 .ai-badge
    免责声明 .disclaimer-text
*/

/* 修改段落样式 */
/* .main-content p {
    font-size: 18px;          // 字体大小
    line-height: 1.8;         // 行高
    margin-bottom: 20px;      // 底部间距
    text-indent: 2em;         // 首行缩进
} */

/* 修改标题样式 */
/* .main-content h1 {
    font-size: 28px;          // 标题字体大小
    font-weight: bold;        // 字体粗细
    color: #2563eb;           // 标题颜色
    text-align: center;       // 居中对齐
    border-bottom: 2px solid #2563eb; // 底部边框
    padding-bottom: 10px;     // 底部内边距
} */

/* 修改列表样式 */
/* .main-content ul li {
    margin-bottom: 8px;       // 列表项间距
    padding-left: 10px;       // 左侧内边距
} */

/* 修改代码块样式 */
/* .main-content pre {
    background-color: #f8f9fa; // 背景颜色
    border: 1px solid #e9ecef; // 边框
    border-radius: 8px;       // 圆角
    padding: 20px;            // 内边距
    font-family: 'Courier New', monospace; // 等宽字体
} */

/* 修改引用样式 */
/* .main-content blockquote {
    background-color: #f8f9fa; // 背景颜色
    border-left: 4px solid #007bff; // 左边框
    padding: 15px 20px;       // 内边距
    margin: 20px 0;           // 外边距
    font-style: italic;       // 斜体
} */

/* 修改表格样式 */
/* .main-content table {
    border-collapse: collapse; // 边框合并
    width: 100%;              // 宽度
} */

/* .main-content table th,
.main-content table td {
    border: 1px solid #dee2e6; // 边框
    padding: 12px;            // 内边距
    text-align: left;         // 文字对齐
} */

/* .main-content table th {
    background-color: #f8f9fa; // 表头背景
    font-weight: bold;        // 字体粗细
} */

/* 添加阴影效果 */
/* .render-container {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); // 阴影
    border-radius: 15px;      // 圆角
} */

/* 自定义数学公式样式 */
/* .katex {
    color: #2563eb !important; // 公式颜色
} */

/* .katex-display {
    background-color: #f8f9fa; // 块级公式背景
    padding: 15px;            // 内边距
    border-radius: 8px;       // 圆角
    margin: 20px 0 !important; // 外边距
} */

/* 使用以上样式时，请删除注释符号 /* 和 */ 
/* 更多CSS属性请参考相关文档 */`;

                    monacoEditor = monaco.editor.create(container, {
                        value: elements.customCss.value || defaultCssContent,
                        language: 'css',
                        theme: document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        wordWrap: 'on',
                        scrollbar: {
                            vertical: 'auto',
                            horizontal: 'auto'
                        }
                    });

                    // 同步编辑器内容到textarea
                    elements.customCss.value = monacoEditor.getValue();

                    // Link editor changes to the image generation
                    monacoEditor.onDidChangeModelContent(() => {
                        const cssValue = monacoEditor.getValue();
                        elements.customCss.value = cssValue;
                        elements.customCssStyle.textContent = cssValue;
                        generateImage();
                        saveSettings();
                    });
                });

                // --- Theme Switching for Editor ---
                const themeObserver = new MutationObserver((mutations) => {
                    mutations.forEach(mutation => {
                        if (mutation.attributeName === 'class' && monacoEditor) {
                            const isDark = document.documentElement.classList.contains('dark');
                            monaco.editor.setTheme(isDark ? 'vs-dark' : 'vs');
                        }
                    });
                });
                themeObserver.observe(document.documentElement, { attributes: true });

                // 初始化应用
                init();
            });
        });
    </script>


</body>

</html>
